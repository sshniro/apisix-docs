(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{161:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return l})),a.d(t,"metadata",(function(){return i})),a.d(t,"rightToc",(function(){return b})),a.d(t,"default",(function(){return p}));var n=a(2),r=a(9),c=(a(0),a(179)),l={},i={id:"plugins/en/proxy-cache",title:"proxy-cache",description:"\x3c!--",source:"@site/docs/plugins/en/proxy-cache.md",permalink:"/docs/plugins/en/proxy-cache",editUrl:"https://github.com/apache/incubator-apisix/edit/master/website/docs/plugins/en/proxy-cache.md",sidebar:"docs",previous:{title:"mqtt-proxy",permalink:"/docs/plugins/en/mqtt-proxy"},next:{title:"proxy-mirror",permalink:"/docs/plugins/en/proxy-mirror"}},b=[{value:"Attributes",id:"attributes",children:[{value:"Examples",id:"examples",children:[]}]},{value:"Disable Plugin",id:"disable-plugin",children:[]}],o={rightToc:b};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(c.b)("wrapper",Object(n.a)({},o,a,{components:t,mdxType:"MDXLayout"}),Object(c.b)("h1",{id:"proxy-cache"},"proxy-cache"),Object(c.b)("p",null,"The proxy-cache plugin, which provides the ability to cache upstream response data and can be used with other plugins. The plugin supports disk-based caching and will support the memory-based caching in the future. The data that needs to be cached can be determined by the response code or request method and more complex caching policies can be configured by no_cache and cache_bypass attributes."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Note"),":"),Object(c.b)("ol",null,Object(c.b)("li",{parentName:"ol"},"The cache expiration time cannot be configured dynamically. The expiration time can only be set by the upstream response header ",Object(c.b)("inlineCode",{parentName:"li"},"Expires")," or ",Object(c.b)("inlineCode",{parentName:"li"},"Cache-Control"),", and the default cache expiration time is 10s if there is no ",Object(c.b)("inlineCode",{parentName:"li"},"Expires")," or ",Object(c.b)("inlineCode",{parentName:"li"},"Cache-Control")," in the upstream response header"),Object(c.b)("li",{parentName:"ol"},"If the upstream service is not available and APISIX will return 502 or 504, then 502 or 504 will be cached for 10s.")),Object(c.b)("h2",{id:"attributes"},"Attributes"),Object(c.b)("table",null,Object(c.b)("thead",{parentName:"table"},Object(c.b)("tr",{parentName:"thead"},Object(c.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Name"),Object(c.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Requirement"),Object(c.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Type"),Object(c.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Description"))),Object(c.b)("tbody",{parentName:"table"},Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"cache_zone"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"required"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"string"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Specify which cache area to use, each cache area can be configured with different paths. In addition, cache areas can be predefined in conf/config.yaml file")),Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"cache_key"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"required"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"array","[string]"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"key of a cache, can use variables. For example: ",'["$host", "$uri", "-cache-id"]')),Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"cache_bypass"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"optional"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"array","[string]"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Whether to skip cache retrieval. That is, do not look for data in the cache. It can use variables, and note that cache data retrieval will be skipped when the value of this attribute is not empty or not '0'. For example: ",'["$arg_bypass"]')),Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"cache_method"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"optional"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"array","[string]"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Decide whether to be cached according to the request method")),Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"cache_http_status"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"optional"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"array","[integer]"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Decide whether to be cached according to the upstream response status")),Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"hide_cache_headers"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"optional"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"boolean"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Whether to return the Expires and Cache-Control response headers to the client, the default is false")),Object(c.b)("tr",{parentName:"tbody"},Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"no_cache"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"optional"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"array","[string]"),Object(c.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Whether to cache data, it can use variables, and note that the data will not be cached when the value of this attribute is not empty or not '0'.")))),Object(c.b)("p",null,"Note:"),Object(c.b)("ol",null,Object(c.b)("li",{parentName:"ol"},"The variable starts with $."),Object(c.b)("li",{parentName:"ol"},"The attribute can use a combination of the variable and the string, but it needs to be written separately as an array, and the final values are stitched together after the variable is parsed.")),Object(c.b)("h3",{id:"examples"},"Examples"),Object(c.b)("h4",{id:"enable-the-plugin"},"Enable the plugin"),Object(c.b)("p",null,"1:  enable the proxy-cache plugin for a specific route :"),Object(c.b)("pre",null,Object(c.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'curl http://127.0.0.1:9080/apisix/admin/routes/1  -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "plugins": {\n        "proxy-cache": {\n           "cache_zone": "disk_cache_one",\n           "cache_key":  ["$uri", "-cache-id"],\n           "cache_bypass": ["$arg_bypass"],\n           "cache_method": ["GET"],\n           "cache_http_status": [200],\n           "hide_cache_headers": true,\n           "no_cache": ["$arg_test"]\n        }\n    },\n    "upstream": {\n        "nodes": {\n            "127.0.0.1:1999": 1\n        },\n        "type": "roundrobin"\n    },\n    "uri": "/hello"\n}\'\n')),Object(c.b)("p",null,"Test Plugin:"),Object(c.b)("pre",null,Object(c.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"$ curl http://127.0.0.1:9080/hello -i\nHTTP/1.1 200 OK\nContent-Type: application/octet-stream\nContent-Length: 6\nConnection: keep-alive\nServer: APISIX web server\nDate: Tue, 03 Mar 2020 10:45:36 GMT\nLast-Modified: Tue, 03 Mar 2020 10:36:38 GMT\nApisix-Cache-Status: MISS\n\nhello\n")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"http status is '200' and the response header contains 'Apisix-Cache-Status' to indicate that the plug-in is enabled.")),Object(c.b)("p",null,"2: Verify that the file is cached, request the address above again:"),Object(c.b)("pre",null,Object(c.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"$ curl http://127.0.0.1:9080/hello -i\nHTTP/1.1 200 OK\nContent-Type: application/octet-stream\nContent-Length: 6\nConnection: keep-alive\nServer: APISIX web server\nDate: Tue, 03 Mar 2020 11:14:46 GMT\nLast-Modified: Thu, 20 Feb 2020 14:21:41 GMT\nApisix-Cache-Status: HIT\n\nhello\n")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"Response header  Apisix-Cache-Status has changed to HIT, indicating that the file has been cached.")),Object(c.b)("p",null,"3: How to clean up the cached file, simply specify the request method as PURGE:"),Object(c.b)("pre",null,Object(c.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"$ curl -i http://127.0.0.1:9080/hello -X PURGE\nHTTP/1.1 200 OK\nDate: Tue, 03 Mar 2020 11:17:35 GMT\nContent-Type: text/plain\nTransfer-Encoding: chunked\nConnection: keep-alive\nServer: APISIX web server\n")),Object(c.b)("blockquote",null,Object(c.b)("p",{parentName:"blockquote"},"The response status is 200, indicating that the file was deleted successfully. And return 404 if the file is not found.")),Object(c.b)("h2",{id:"disable-plugin"},"Disable Plugin"),Object(c.b)("p",null,"Remove the corresponding JSON in the plugin configuration to disable the plugin immediately without restarting the service:"),Object(c.b)("pre",null,Object(c.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'curl http://127.0.0.1:9080/apisix/admin/routes/1  -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "uri": "/hello",\n    "plugins": {},\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:1999": 1\n        }\n    }\n}\'\n')),Object(c.b)("p",null,"The plugin has been disabled now."))}p.isMDXComponent=!0},179:function(e,t,a){"use strict";a.d(t,"a",(function(){return s})),a.d(t,"b",(function(){return d}));var n=a(0),r=a.n(n);function c(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){c(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function b(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},c=Object.keys(e);for(n=0;n<c.length;n++)a=c[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(n=0;n<c.length;n++)a=c[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=r.a.createContext({}),p=function(e){var t=r.a.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},s=function(e){var t=p(e.components);return r.a.createElement(o.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},h=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,c=e.originalType,l=e.parentName,o=b(e,["components","mdxType","originalType","parentName"]),s=p(a),h=n,d=s["".concat(l,".").concat(h)]||s[h]||u[h]||c;return a?r.a.createElement(d,i(i({ref:t},o),{},{components:a})):r.a.createElement(d,i({ref:t},o))}));function d(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var c=a.length,l=new Array(c);l[0]=h;var i={};for(var b in t)hasOwnProperty.call(t,b)&&(i[b]=t[b]);i.originalType=e,i.mdxType="string"==typeof e?e:n,l[1]=i;for(var o=2;o<c;o++)l[o]=a[o];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,a)}h.displayName="MDXCreateElement"}}]);