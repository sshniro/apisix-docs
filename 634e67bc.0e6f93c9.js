(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{157:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return b}));var a=n(2),r=n(9),i=(n(0),n(179)),o={},l={id:"plugins/en/authz-keycloak",title:"authz-keycloak",description:"\x3c!--",source:"@site/docs/plugins/en/authz-keycloak.md",permalink:"/docs/plugins/en/authz-keycloak",editUrl:"https://github.com/apache/incubator-apisix/edit/master/website/docs/plugins/en/authz-keycloak.md"},c=[{value:"Name",id:"name",children:[]},{value:"Attributes",id:"attributes",children:[{value:"Policy Enforcement Mode",id:"policy-enforcement-mode",children:[]}]},{value:"How To Enable",id:"how-to-enable",children:[]},{value:"Test Plugin",id:"test-plugin",children:[]},{value:"Disable Plugin",id:"disable-plugin",children:[]},{value:"Examples",id:"examples",children:[]},{value:"Future Development",id:"future-development",children:[]}],u={rightToc:c};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"name"},"Name"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"authz-keycloak")," is an authorization plugin to be used with the Keycloak Identity Server. Keycloak is an OAuth/OIDC and\nUMA compliant Ideneity Server. Although, its developed to working in conjunction with Keycloak it should work with any\nOAuth/OIDC and UMA compliant identity providers as well."),Object(i.b)("p",null,"For more information on JWT, refer to ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.keycloak.org/docs/latest/authorization_services"}),"Keycloak Authorization Docs")," for more information."),Object(i.b)("h2",{id:"attributes"},"Attributes"),Object(i.b)("table",null,Object(i.b)("thead",{parentName:"table"},Object(i.b)("tr",{parentName:"thead"},Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Name"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Requirement"),Object(i.b)("th",Object(a.a)({parentName:"tr"},{align:null}),"Description"))),Object(i.b)("tbody",{parentName:"table"},Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"token_endpoint"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"required"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"A OAuth2-compliant Token Endpoint that supports the urn:ietf:params:oauth:grant-type:uma-ticket grant type.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"grant_type"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"optional"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Default value is ",Object(i.b)("inlineCode",{parentName:"td"},"urn:ietf:params:oauth:grant-type:uma-ticket"),".")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"audience"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"optional"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"The client identifier of the resource server to which the client is seeking access. This parameter is mandatory in case the permission parameter is defined.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"permissions"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"optional"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"This parameter is optional. A string representing a set of one or more resources and scopes the client is seeking access.  The format of the string must be: RESOURCE_ID#SCOPE_ID.")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"timeout"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"optional"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Timeout for the http connection with the Identity Server. Default is 3 seconds")),Object(i.b)("tr",{parentName:"tbody"},Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"policy_enforcement_mode"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"required"),Object(i.b)("td",Object(a.a)({parentName:"tr"},{align:null}),"Enforcing or Permissive.")))),Object(i.b)("h3",{id:"policy-enforcement-mode"},"Policy Enforcement Mode"),Object(i.b)("p",null,"Specifies how policies are enforced when processing authorization requests sent to the server."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Enforcing")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"(default mode) Requests are denied by default even when there is no policy associated with a given resource.")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Permissive")),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"Requests are allowed even when there is no policy associated with a given resource.")),Object(i.b)("h2",{id:"how-to-enable"},"How To Enable"),Object(i.b)("p",null,"Create a route and enable the authz-keycloak plugin on the route:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-shell"}),'curl http://127.0.0.1:9080/apisix/admin/routes/5 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "uri": "/get",\n    "plugins": {\n        "authz-keycloak": {\n            "token_endpoint": "http://127.0.0.1:8090/auth/realms/{client_id}/protocol/openid-connect/token",\n            "permissions": ["resource name#scope name"],\n            "audience": "Client ID"\n        }\n    },\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:8080": 1\n        }\n    }\n}\n')),Object(i.b)("h2",{id:"test-plugin"},"Test Plugin"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-shell"}),"curl http://127.0.0.1:9080/get -H 'Authorization: Bearer {JWT Token}'\n")),Object(i.b)("h2",{id:"disable-plugin"},"Disable Plugin"),Object(i.b)("p",null,"Remove the corresponding json configuration in the plugin configuration to disable the ",Object(i.b)("inlineCode",{parentName:"p"},"authz-keycloak"),".\nAPISIX plugins are hot-reloaded, therefore no need to restart APISIX."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-shell"}),'curl http://127.0.0.1:9080/apisix/admin/routes/5 -H \'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1\' -X PUT -d \'\n{\n    "uri": "/get",\n    "plugins": {\n    },\n    "upstream": {\n        "type": "roundrobin",\n        "nodes": {\n            "127.0.0.1:8080": 1\n        }\n    }\n}\n')),Object(i.b)("h2",{id:"examples"},"Examples"),Object(i.b)("p",null,"Checkout the unit test for of the authz-keycloak.t to understand how the authorization policies can be integrated into your\nAPI workflows. Run the following docker image and visit ",Object(i.b)("inlineCode",{parentName:"p"},"http://localhost:8090")," to view the associated policies for the unit tests."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"docker run -e KEYCLOAK_USER=admin -e KEYCLOAK_PASSWORD=123456 -p 8090:8080 sshniro/keycloak-apisix\n")),Object(i.b)("p",null,"The following image shows how the policies are configures in the Keycloak server."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"../images/plugin/authz-keycloak.png",alt:"Keycloak policy design"}))),Object(i.b)("h2",{id:"future-development"},"Future Development"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Currently the authz-plugin requires to define the resource name and required scopes inorder to enforce policies for the routes.\nHowever, Keycloak's official adapters (Java, JS) also provides path matching by querying Keycloak paths dynamically, and\nlazy loading the paths to identify resources. Future version on authz-plugin will support this functionality.")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("p",{parentName:"li"},"Support to read scope and configurations from the Keycloak JSON File"))))}b.isMDXComponent=!0},179:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=r.a.createContext({}),b=function(e){var t=r.a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=b(e.components);return r.a.createElement(u.Provider,{value:t},e.children)},s={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=b(n),d=a,m=p["".concat(o,".").concat(d)]||p[d]||s[d]||i;return n?r.a.createElement(m,l(l({ref:t},u),{},{components:n})):r.a.createElement(m,l({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);